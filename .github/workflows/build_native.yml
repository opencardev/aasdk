name: AASDK Build and Test

name: Deprecated - build_native

# This workflow has been replaced by `ci.yml`.
# Keep this file as a placeholder to avoid accidental triggers.

on: {}
            
            echo "Package $(basename $package) structure looks good"
          fi
        done

    - name: Generate test report
      run: |
        echo "# AASDK Build Test Report" > test-report.md
        echo "" >> test-report.md
        echo "## Build Summary" >> test-report.md
        echo "- Build Date: $(date -u)" >> test-report.md
        echo "- Commit: ${{ github.sha }}" >> test-report.md
        echo "- Branch: ${{ github.ref_name }}" >> test-report.md
        echo "" >> test-report.md
        echo "## Package Information" >> test-report.md
        
        for package in ./test-packages/*.deb; do
          if [ -f "$package" ]; then
            echo "### $(basename $package)" >> test-report.md
            echo '```' >> test-report.md
            dpkg-deb --field "$package" Package Architecture Version Depends >> test-report.md
            echo '```' >> test-report.md
            echo "" >> test-report.md
          fi
        done

    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: aasdk-test-report-${{ github.run_number }}
        path: test-report.md
        retention-days: 90

  release:
    needs: [prepare, build, test]
    runs-on: ubuntu-latest
    if: github.event.inputs.trigger_release == 'true' || github.event.inputs.trigger_apt_publish == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
    - name: Trigger Release Workflow
      if: github.event.inputs.trigger_release == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      run: |
        echo "Triggering release workflow with build run ID: ${{ github.run_id }}"
        gh workflow run release.yml --repo ${{ github.repository }} \
          -f build_run_id="${{ github.run_id }}" \
          -f version="${{ github.event.inputs.version }}" \
          -f create_draft="false"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_REPO: ${{ github.repository }}

    - name: Trigger APT Publish Workflow
      if: github.event.inputs.trigger_apt_publish == 'true' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
      run: |
          echo "Dispatching to packages repo Aptly workflow with build run ID: ${{ github.run_id }} (distribution: ${{ needs.prepare.outputs.distribution }})"
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.PACKAGES_REPO_TOKEN }}" \
            https://api.github.com/repos/opencardev/packages/dispatches \
            -d '{
              "event_type": "publish-apt-packages",
              "client_payload": {
                "source_repo": "${{ github.repository }}",
                "build_run_id": "${{ github.run_id }}",
                "apt_import": true,
                "distribution": "${{ needs.prepare.outputs.distribution }}"
              }
            }'
          echo "âœ… APT repository update triggered successfully!"
          echo "Check: https://github.com/opencardev/packages/actions"
      env:
          PACKAGES_REPO_TOKEN: ${{ secrets.PACKAGES_REPO_TOKEN }}

    - name: Build Summary
      run: |
        echo "## Build Complete! ðŸŽ‰"
        echo "Build Run ID: \`${{ github.run_id }}\`"
        echo ""
        echo "### Next Steps:"
        echo "You can now manually trigger workflows using this build:"
        echo ""
        echo "- Trigger release: release.yml with build_run_id=${{ github.run_id }}"
        echo "- Trigger APT publish: apt-publish-aptly.yml or packages repo dispatch"

    # Release creation is handled by the dedicated release.yml workflow. No inline release here.
