name: AASDK APT Repository Upload

on:
  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'Build run ID to publish to APT repo'
        required: true
        type: string
      distribution:
        description: 'Distribution to publish to'
        required: false
        default: 'trixie'
        type: choice
        options:
          - trixie
          - bookworm
          - both

jobs:
  # First job: get the list of .deb files from the build artifacts
  prepare:
    runs-on: ubuntu-latest
    outputs:
      deb_files: ${{ steps.list_files.outputs.deb_files }}
      
    steps:
    - name: Download artifacts from build run
      run: |
        echo "Downloading artifacts from run ID: ${{ inputs.build_run_id }}"
        
        # Download all artifacts from the specified run
        gh run download ${{ inputs.build_run_id }} --dir ./downloaded-artifacts
        
        echo "Downloaded artifacts structure:"
        find ./downloaded-artifacts -type f -name "*.deb" | head -20
        
        # Verify we have packages
        if [ ! "$(find ./downloaded-artifacts -name "*.deb" 2>/dev/null)" ]; then
          echo "Error: No .deb packages found in build run ${{ inputs.build_run_id }}"
          exit 1
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: List .deb files for matrix
      id: list_files
      run: |
        echo "Creating matrix of .deb files..."
        
        # Create JSON array of .deb files
        deb_files="["
        first=true
        
        find ./downloaded-artifacts -name "*.deb" -type f | while read -r deb_file; do
          filename=$(basename "$deb_file")
          if [ "$first" = true ]; then
            first=false
          else
            echo "," >> /tmp/deb_files_part
          fi
          echo "\"$filename\"" >> /tmp/deb_files_part
        done
        
        if [ -f /tmp/deb_files_part ]; then
          deb_files="$deb_files$(cat /tmp/deb_files_part)]"
        else
          deb_files="[]"
        fi
        
        echo "deb_files=$deb_files" >> $GITHUB_OUTPUT
        echo "Found .deb files: $deb_files"

    - name: Upload .deb files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: deb-files-for-apt
        path: ./downloaded-artifacts/**/*.deb
        retention-days: 1

  # Second job: upload each .deb file to APT repo using matrix strategy
  upload-trixie:
    needs: prepare
    if: inputs.distribution == 'trixie' || inputs.distribution == 'both'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        deb_file: ${{ fromJson(needs.prepare.outputs.deb_files) }}
      fail-fast: false
      
    steps:
    - name: Download .deb files
      uses: actions/download-artifact@v4
      with:
        name: deb-files-for-apt
        path: ./deb-files

    - name: Upload ${{ matrix.deb_file }} to Trixie
      uses: MauroDruwel/apt-repo-action@v4
      with:
        github_token: ${{ secrets.PACKAGES_REPO_TOKEN }}
        repo_supported_arch: |
          amd64
          arm64
          armhf
        repo_supported_version: |
          trixie
        file: ./deb-files/${{ matrix.deb_file }}
        file_target_version: trixie
        target_repository: opencardev/packages
        private_key: ${{ secrets.APT_SIGNING_KEY }}
        key_passphrase: ${{ secrets.APT_SIGNING_PASSPHRASE }}
        public_key: ${{ secrets.APT_SIGNING_PUBLIC_KEY }}

  upload-bookworm:
    needs: prepare
    if: inputs.distribution == 'bookworm' || inputs.distribution == 'both'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        deb_file: ${{ fromJson(needs.prepare.outputs.deb_files) }}
      fail-fast: false
      
    steps:
    - name: Download .deb files
      uses: actions/download-artifact@v4
      with:
        name: deb-files-for-apt
        path: ./deb-files

    - name: Upload ${{ matrix.deb_file }} to Bookworm
      uses: MauroDruwel/apt-repo-action@v4
      with:
        github_token: ${{ secrets.PACKAGES_REPO_TOKEN }}
        repo_supported_arch: |
          amd64
          arm64
          armhf
        repo_supported_version: |
          bookworm
        file: ./deb-files/${{ matrix.deb_file }}
        file_target_version: bookworm
        target_repository: opencardev/packages
        private_key: ${{ secrets.APT_SIGNING_KEY }}
        key_passphrase: ${{ secrets.APT_SIGNING_PASSPHRASE }}
        public_key: ${{ secrets.APT_SIGNING_PUBLIC_KEY }}

  summary:
    needs: [prepare, upload-trixie, upload-bookworm]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Summary
      run: |
        echo "## APT Repository Upload Complete"
        echo "Build Run ID: ${{ inputs.build_run_id }}"
        echo "Distribution: ${{ inputs.distribution }}"
        echo "Files processed: ${{ needs.prepare.outputs.deb_files }}"