name: Auto-update Wiki from Code Comments

on:
  push:
    branches: [ main, development ]
    paths:
      - 'src/**'
      - 'aasdk_proto/**'
      - 'protobuf/**'
      - 'include/**'
      - 'Doxyfile'
      - '.github/workflows/auto-wiki-docs.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (doxygen, unzip)
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz unzip curl ca-certificates

      - name: Verify dependencies
        run: |
          echo "=== Checking required tools ==="
          which doxygen && doxygen --version || echo "doxygen not found"
          which unzip && unzip -version | head -5 || echo "unzip not found"
          which curl && curl --version | head -1 || echo "curl not found"
          echo "=== System information ==="
          uname -a
          ldd --version | head -1

      - name: Generate Markdown from code comments
        run: |
          bash .github/scripts/docs/generate_wiki_docs.sh
        env:
          VERBOSE: 1

      - name: Prepare Wiki workspace
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          rm -rf wiki
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.wiki.git" wiki
          mkdir -p wiki/Autogenerated
          rsync -a --delete build/docs/wiki-md/ wiki/Autogenerated/

      - name: Commit & push to Wiki
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: github-actions@users.noreply.github.com
        run: |
          set -e
          cd wiki
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git commit -m "docs(wiki): auto-update API docs from code comments"
          git push origin HEAD:master || git push origin HEAD:main || true
